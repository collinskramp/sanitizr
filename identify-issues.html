<!DOCTYPE html>
<html>
<head><title>Identify Issues</title></head>
<body>
<div id="output"></div>
<script src="storage.js"></script>
<script src="sanitizer.js"></script>
<script>
function log(msg) {
    document.getElementById('output').innerHTML += msg + '<br>';
    console.log(msg);
}

const testInput = `{"aws": {"password": "AKIAFAKE1234567890","secretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYFAKE","region": "us-east-1"}}`;

log('=== ISSUE IDENTIFICATION ===');
log('Input: ' + testInput);

const rules = window.storage.getRules();
log('Total rules: ' + rules.length);

// Check for missing secretAccessKey rule
const secretAccessKeyRule = rules.find(r => r.type === 'kv' && r.pattern === 'secretAccessKey');
log('SecretAccessKey KV rule exists: ' + !!secretAccessKeyRule);

if (!secretAccessKeyRule) {
    log('❌ ISSUE 1: Missing secretAccessKey key-value rule');
}

// Check password rule
const passwordRule = rules.find(r => r.type === 'kv' && r.pattern === 'password');
log('Password KV rule exists: ' + !!passwordRule + ' (enabled: ' + (passwordRule?.enabled) + ')');

// Test key-value detection manually
log('\n=== MANUAL KV PATTERN TESTING ===');

// Test password detection
const passwordPattern = /"password"\s*:\s*"([^"]+)"/gi;
const passwordMatches = [...testInput.matchAll(passwordPattern)];
log('Password pattern matches: ' + passwordMatches.length);
passwordMatches.forEach(match => {
    log('  Match: "' + match[0] + '", Value: "' + match[1] + '"');
});

// Test secretAccessKey detection
const secretPattern = /"secretAccessKey"\s*:\s*"([^"]+)"/gi;
const secretMatches = [...testInput.matchAll(secretPattern)];
log('SecretAccessKey pattern matches: ' + secretMatches.length);
secretMatches.forEach(match => {
    log('  Match: "' + match[0] + '", Value: "' + match[1] + '"');
});

// Test AWS access key detection
const awsAccessKeyPattern = /\b(?:AKIA|ASIA|AROA|AIDA|AGPA|AIPA|ANPA|ANVA|APKA)[0-9A-Z]{16}\b/g;
const awsAccessMatches = testInput.match(awsAccessKeyPattern);
log('AWS Access Key matches: ' + (awsAccessMatches ? awsAccessMatches.length : 0));
if (awsAccessMatches) {
    awsAccessMatches.forEach(match => log('  Match: "' + match + '"'));
}

// Test AWS secret key detection
const awsSecretKeyPattern = /\b[A-Za-z0-9/+=]{40}\b/g;
const awsSecretMatches = testInput.match(awsSecretKeyPattern);
log('AWS Secret Key matches: ' + (awsSecretMatches ? awsSecretMatches.length : 0));
if (awsSecretMatches) {
    awsSecretMatches.forEach(match => log('  Match: "' + match + '"'));
}

// Test actual detection
log('\n=== ACTUAL DETECTION TEST ===');
const detections = window.sanitizer.detect(testInput, { rules });
log('Detections found: ' + detections.length);
detections.forEach((d, i) => {
    log(`${i+1}. Rule: ${d.ruleId}, Match: "${d.match}", Pos: ${d.startIndex}-${d.endIndex}`);
});

// Test sanitization
log('\n=== SANITIZATION TEST ===');
const sanitized = window.sanitizer.sanitize(testInput, { rules });
log('Original: ' + testInput);
log('Sanitized: ' + sanitized);
log('Changed: ' + (sanitized !== testInput));

if (sanitized === testInput) {
    log('❌ ISSUE 2: No sanitization occurred');
} else {
    log('✅ Sanitization working');
}
</script>
</body>
</html>